// --- –ù–ê–°–¢–†–û–ô–ö–ò ---
const MY_CHAT_ID = 'CHAT_ID'; // ‚ö†Ô∏è –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π Telegram ID
const TOKEN = 'TOKEN'; // –¢–≤–æ–π –±–æ—Ç-—Ç–æ–∫–µ–Ω
const TELEGRAM_API = `https://api.telegram.org/bot${TOKEN}`;
const SHEET_URL = 'LINK'; // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É
const SHEET_NAME = 'name_of_list'; // –ò–º—è –ª–∏—Å—Ç–∞

// –£—Ä–æ–∫–∏ –Ω–∞ 21 –¥–µ–Ω—å (–Ω–∞—á–∏–Ω–∞—è —Å 18.08.2025)
const LESSONS = [
  "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üåø –î–µ–Ω—å 1: –°–µ–≥–æ–¥–Ω—è –Ω–∞—á–Ω–∏ —Å –¥–∞–æ—Å—Å–∫–æ–≥–æ –¥—ã—Ö–∞–Ω–∏—è. 10 –º–∏–Ω—É—Ç: –¥—ã—à–∏ –∂–∏–≤–æ—Ç–æ–º, —Ä—É–∫–∏ –Ω–∞ –Ω–∏–∂–Ω–∏–π –¥–∞–Ω—å—Ç—è–Ω—å (3 –ø–∞–ª—å—Ü–∞ –Ω–∏–∂–µ –ø—É–ø–∫–∞). –ß—É–≤—Å—Ç–≤—É–π —Ç–µ–ø–ª–æ.",
  "–î–µ–Ω—å 2: –ü—Ä–æ–¥–æ–ª–∂–∞–π –¥—ã—Ö–∞–Ω–∏–µ. –î–æ–±–∞–≤—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é: –ø—Ä–µ–¥—Å—Ç–∞–≤—å, –∫–∞–∫ —Å –∫–∞–∂–¥—ã–º –≤–¥–æ—Ö–æ–º –≤ –¥–∞–Ω—å—Ç—è–Ω—å –ø—Ä–∏—Ö–æ–¥–∏—Ç –∑–æ–ª–æ—Ç–æ–π —Å–≤–µ—Ç.",
  "–î–µ–Ω—å 3: –ü–æ–ø—Ä–æ–±—É–π '–ø–æ–¥—É—Ç—å' —ç–Ω–µ—Ä–≥–∏—é –æ—Ç –¥–∞–Ω—å—Ç—è–Ω—è –∫ –∫–æ–ø—á–∏–∫—É –∏ –æ–±—Ä–∞—Ç–Ω–æ (–≤–¥–æ—Ö —Ç—É–¥–∞, –≤—ã–¥–æ—Ö —Å—é–¥–∞). –ù–µ —Ñ–æ—Ä—Å–∏—Ä—É–π.",
  "–î–µ–Ω—å 4: –£–¥–µ–ª–∏ 5 –º–∏–Ω—É—Ç –ø—Ä–æ—Å—Ç–æ –æ—â—É—â–µ–Ω–∏—é —Ç–µ–ª–∞. –ó–∞–º–µ—á–∞–π, –≥–¥–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ ‚Äî –¥—ã—à–∏ —Ç—É–¥–∞.",
  "–î–µ–Ω—å 5: –ü–æ–≤—Ç–æ—Ä–∏ –≤—á–µ—Ä–∞—à–Ω–µ–µ, –Ω–æ –¥–æ–±–∞–≤—å –ø—Ä–∏–∂–∞—Ç–∏–µ —è–∑—ã–∫–∞ –∫ –Ω—ë–±—É ‚Äî '–º–æ—Å—Ç —ç–Ω–µ—Ä–≥–∏–∏'.",
  "–î–µ–Ω—å 6: –ü—Ä–µ–¥—Å—Ç–∞–≤—å, –∫–∞–∫ —ç–Ω–µ—Ä–≥–∏—è –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –ø–æ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫—É –Ω–∞ –≤–¥–æ—Ö–µ. –¢–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è.",
  "–î–µ–Ω—å 7: –ü–æ–ø—Ä–æ–±—É–π –ø–æ–ª–Ω—ã–π –æ–±—Ä–∞–∑: –≤–¥–æ—Ö ‚Äî —ç–Ω–µ—Ä–≥–∏—è –≤–≤–µ—Ä—Ö –ø–æ —Å–ø–∏–Ω–µ, –≤—ã–¥–æ—Ö ‚Äî –≤–Ω–∏–∑ –ø–æ –ø–µ—Ä–µ–¥—É. –ë–µ–∑ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è.",
  "–î–µ–Ω—å 8: –°–¥–µ–ª–∞–π 3‚Äì5 –∫—Ä—É–≥–æ–≤ –ú–∏–∫—Ä–æ–∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –æ—Ä–±–∏—Ç–∞. –í–¥–æ—Ö ‚Äî –≤–≤–µ—Ä—Ö, –≤—ã–¥–æ—Ö ‚Äî –≤–Ω–∏–∑.",
  "–î–µ–Ω—å 9: –£–≤–µ–ª–∏—á—å –¥–æ 9 –∫—Ä—É–≥–æ–≤. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π, —á—Ç–æ –æ—á–∏—â–∞–µ—à—å —Ç–µ–ª–æ —Å –∫–∞–∂–¥—ã–º –∫—Ä—É–≥–æ–º.",
  "–î–µ–Ω—å 10: –î–æ–±–∞–≤—å —Ü–≤–µ—Ç: –≤–¥–æ—Ö ‚Äî –±–µ–ª—ã–π —Å–≤–µ—Ç –≤–≤–µ—Ä—Ö, –≤—ã–¥–æ—Ö ‚Äî —Ç—å–º–∞ —É—Ö–æ–¥–∏—Ç –≤–Ω–∏–∑.",
  "–î–µ–Ω—å 11: –ü—Ä–∞–∫—Ç–∏–∫—É–π —É—Ç—Ä–æ–º. –ó–∞–º–µ—Ç—å, –∫–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ.",
  "–î–µ–Ω—å 12: –°–¥–µ–ª–∞–π 12 –∫—Ä—É–≥–æ–≤. –ï—Å–ª–∏ —É—Å—Ç–∞–ª ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Å—å. –ì–ª–∞–≤–Ω–æ–µ ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å.",
  "–î–µ–Ω—å 13: –°–æ–µ–¥–∏–Ω–∏ –¥—ã—Ö–∞–Ω–∏–µ, –≤–Ω–∏–º–∞–Ω–∏–µ –∏ —è–∑—ã–∫ –Ω–∞ –Ω—ë–±–µ. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞.",
  "–î–µ–Ω—å 14: –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ –≤ –Ω–∏–∂–Ω–µ–º –¥–∞–Ω—å—Ç—è–Ω–µ —Ä–æ–∂–¥–∞–µ—Ç—Å—è —ç–ª–∏–∫—Å–∏—Ä ‚Äî —Ç—ë–ø–ª—ã–π —à–∞—Ä —Å–≤–µ—Ç–∞.",
  "–î–µ–Ω—å 15: –ù–∞–ø—Ä–∞–≤—å —ç—Ç–æ—Ç —à–∞—Ä –ø–æ –ø–æ–ª–Ω–æ–º—É –∫—Ä—É–≥—É 9 —Ä–∞–∑. –û—Å—Ç–∞–≤—å –µ–≥–æ –≤ –¥–∞–Ω—å—Ç—è–Ω–µ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ.",
  "–î–µ–Ω—å 16: –ü—Ä–∞–∫—Ç–∏–∫—É–π —Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏. –ù–∞–±–ª—é–¥–∞–π –∑–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –æ—â—É—â–µ–Ω–∏—è–º–∏.",
  "–î–µ–Ω—å 17: –ï—Å–ª–∏ –æ—â—É—â–µ–Ω–∏—è —Å–ª–∞–±—ã–µ ‚Äî –Ω–µ –±–µ–¥–∞. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ ‚Äî —É–∂–µ –¥–µ–π—Å—Ç–≤–∏–µ.",
  "–î–µ–Ω—å 18: –°–¥–µ–ª–∞–π 18 –∫—Ä—É–≥–æ–≤. –ü–æ—á—É–≤—Å—Ç–≤—É–π —Ä–∏—Ç–º, –∫–∞–∫ –ø—É–ª—å—Å –í—Å–µ–ª–µ–Ω–Ω–æ–π.",
  "–î–µ–Ω—å 19: –î–æ–±–∞–≤—å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å —Ç–µ–ª—É –ø–æ—Å–ª–µ –ø—Ä–∞–∫—Ç–∏–∫–∏.",
  "–î–µ–Ω—å 20: –ü–æ–≤—Ç–æ—Ä–∏ –≤—Å—ë —Å —á—É–≤—Å—Ç–≤–æ–º –ø–æ–∫–æ—è –∏ –ø—Ä–∏–Ω—è—Ç–∏—è.",
  "–î–µ–Ω—å 21: –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! üéâ –¢—ã –ø—Ä–æ—à—ë–ª 21 –¥–µ–Ω—å. –ü—Ä–æ–¥–æ–ª–∂–∞–π –ø—Ä–∞–∫—Ç–∏–∫—É ‚Äî —Ç–µ–ø–µ—Ä—å —Ç—ã –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—É–ø–µ–Ω–∏."
];

// === –ï–ñ–ï–î–ù–ï–í–ù–ê–Ø –†–ê–°–°–´–õ–ö–ê ===
function sendDailyLesson() {
  try {
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    const sheet = SpreadsheetApp.openByUrl(SHEET_URL).getSheetByName(SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    const rows = data.slice(1); // –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞

    // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –Ω–∞—à–∏–º ID
    const userRow = rows.find(row => row[0] == MY_CHAT_ID);
    const rowIndex = userRow ? rows.indexOf(userRow) + 2 : null;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let startDate, dayCompleted;

    if (userRow) {
      // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–¥–¥.–º–º.–≥–≥–≥–≥"
      const [day, month, year] = String(userRow[2]).split('.').map(Number);
      if (isNaN(day) || isNaN(month) || isNaN(year)) {
        console.error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã:", userRow[2]);
        return;
      }
      startDate = new Date(year, month - 1, day);
      startDate.setHours(0, 0, 0, 0);
      dayCompleted = userRow[4] ? parseInt(userRow[4]) : 0;
    } else {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º —Å –¥–∞—Ç–æ–π —Å—Ç–∞—Ä—Ç–∞ 18.08.2025
      sheet.appendRow([MY_CHAT_ID, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', '18.08.2025', '', 0]);
      sendTelegramMessage(MY_CHAT_ID, "üå± –ö—É—Ä—Å –∑–∞–ø—É—â–µ–Ω! –ü–µ—Ä–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ‚Äî –∑–∞–≤—Ç—Ä–∞. –ñ–¥–∏!");
      return;
    }

    // –°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø—Ä–æ—à–ª–æ
    const daysSinceStart = Math.floor((today - startDate) / (24 * 60 * 60 * 1000));

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—Ä–æ–∫
    if (daysSinceStart >= 0 && daysSinceStart < 21 && daysSinceStart === dayCompleted) {
      const lessonText = LESSONS[daysSinceStart];
      if (!lessonText) {
        console.error("–£—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –¥–Ω—è:", daysSinceStart);
        return;
      }

      const message = `<b>–î–µ–Ω—å ${daysSinceStart + 1} –∏–∑ 21</b>\n\n${lessonText}`;
      sendTelegramMessage(MY_CHAT_ID, message);

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      if (rowIndex) {
        sheet.getRange(rowIndex, 5).setValue(daysSinceStart + 1); // DayCompleted
        sheet.getRange(rowIndex, 4).setValue(today); // LastSent
      }
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ sendDailyLesson:', error);
  }
}

// === –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø –í TELEGRAM ===
function sendTelegramMessage(chatId, text) {
  if (!text || typeof text !== 'string' || text.trim() === '') {
    console.error('‚ùå –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', text);
    return;
  }

  const payload = {
    method: 'post',
    muteHttpExceptions: true,
    payload: {
      chat_id: chatId,
      text: text,
      parse_mode: 'HTML'
    }
  };

  try {
    const response = UrlFetchApp.fetch(TELEGRAM_API + '/sendMessage', payload);
    const result = JSON.parse(response.getContentText());

    if (result.ok) {
      console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', chatId);
    } else {
      console.error('‚ùå –û—à–∏–±–∫–∞ Telegram API:', result);
      // –ï—Å–ª–∏ "chat not found" ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Ç—ã –Ω–µ –Ω–∞—á–∏–Ω–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º
      if (result.description && result.description.includes('chat not found')) {
        console.error('‚ùó –ß—Ç–æ–±—ã –±–æ—Ç –º–æ–≥ –ø–∏—Å–∞—Ç—å, –Ω–∞–ø–∏—à–∏ –µ–º—É –≤ Telegram: /start');
      }
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error.toString());
  }
}

// === –¢–ï–°–¢: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–±–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∑–∞–ø—É—Å–∫–∞–π –≤—Ä—É—á–Ω—É—é) ===
function testSend() {
  sendTelegramMessage(MY_CHAT_ID, "‚úÖ –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç.");
}
